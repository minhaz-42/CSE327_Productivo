{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Schedule | Intelligent Task Planner</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <!-- Your global stylesheet -->
  <link rel="stylesheet" href="{% static 'accounts/style.css' %}">

  <!-- FullCalendar v6 (all-in-one) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.min.css"/>

  <style>
    :root{
      --primary:#4361ee; --primary-light:#4895ef; --background:#f8f9fa; --surface:#ffffff;
      --on-surface:#212529; --gray-light:#e9ecef; --gray-medium:#adb5bd;
      /* Soft priority colors */
      --soft-red-bg:#fde2e2;     --soft-red-border:#f8b4b4;     --soft-red-text:#7a1f1f;
      --soft-yellow-bg:#fff7d6;  --soft-yellow-border:#ffe08a;  --soft-yellow-text:#6b4f00;
      --soft-green-bg:#dff7e3;   --soft-green-border:#a9e6b0;   --soft-green-text:#1b4332;
    }
    *{box-sizing:border-box} body{background:var(--background); color:#222; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

    /* Layout (same as before, condensed) */
    .app{display:grid;grid-template-areas:"sidebar header" "sidebar main";grid-template-columns:240px 1fr;grid-template-rows:60px 1fr;min-height:100vh}
    .header{grid-area:header;display:flex;justify-content:space-between;align-items:center;padding:0 20px;background:var(--surface);box-shadow:0 2px 4px rgba(0,0,0,.08)}
    .menu-btn{background:none;border:1px solid transparent;padding:6px 10px;border-radius:6px;cursor:pointer}
    .menu-btn:hover{border-color:var(--gray-light)}
    .sidebar{grid-area:sidebar;background:var(--surface);box-shadow:2px 0 4px rgba(0,0,0,.05)}
    .sidebar-nav a{display:flex;gap:10px;padding:12px 20px;text-decoration:none;color:var(--on-surface)}
    .sidebar-nav a.active{background:var(--primary-light);color:#fff}
    .main-content{grid-area:main;padding:20px}
    .calendar-container{background:var(--surface);border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,.06);padding:16px}

    /* FullCalendar tweaks */
    .fc .fc-toolbar-title{font-size:1.25rem}
    .fc .fc-button{background:var(--surface);border:1px solid var(--gray-light);color:var(--on-surface)}
    .fc .fc-button:hover{background:var(--gray-light)}
    .fc .fc-daygrid-day.fc-day-today{background-color:rgba(67,97,238,.08)}

    /* Soft priority styles */
    .fc-event-high{
      background:var(--soft-red-bg)!important; color:var(--soft-red-text)!important;
      border:1px solid var(--soft-red-border)!important;
    }
    .fc-event-medium{
      background:var(--soft-yellow-bg)!important; color:var(--soft-yellow-text)!important;
      border:1px solid var(--soft-yellow-border)!important;
    }
    .fc-event-low{
      background:var(--soft-green-bg)!important; color:var(--soft-green-text)!important;
      border:1px solid var(--soft-green-border)!important;
    }

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal{width:min(520px,94vw);background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);overflow:hidden}
    .modal-header{padding:14px 16px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
    .modal-title{font-size:1.05rem;font-weight:600}
    .modal-body{padding:16px}
    .modal-row{margin:8px 0;color:#333}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.8rem;border:1px solid rgba(0,0,0,.1)}
    .badge-high{background:var(--soft-red-bg);border-color:var(--soft-red-border);color:var(--soft-red-text)}
    .badge-medium{background:var(--soft-yellow-bg);border-color:var(--soft-yellow-border);color:var(--soft-yellow-text)}
    .badge-low{background:var(--soft-green-bg);border-color:var(--soft-green-border);color:var(--soft-green-text)}
    .modal-actions{padding:14px 16px;border-top:1px solid #eee;display:flex;gap:10px;justify-content:flex-end}
    .btn{border:1px solid #ddd;background:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.danger{background:#f44336;border-color:#f44336;color:#fff}
    .close-x{border:none;background:none;font-size:1.2rem;cursor:pointer}

    @media (max-width:992px){
      .app{grid-template-areas:"header" "main";grid-template-columns:1fr}
      .sidebar{display:none}
    }
  </style>
</head>
<body class="light-theme">
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <button class="menu-btn" id="sidebarToggle"><i class="fas fa-bars"></i></button>
        <h1 class="app-title">Intelligent Task Planner</h1>
      </div>
      <div class="header-right">
        <a href="{% url 'logout' %}" class="btn">Logout</a>
        <div class="user-profile"><div class="avatar">{{ user.username|slice:"0:1"|upper }}</div></div>
      </div>
    </header>

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-logo"><h2>TaskPlanner</h2></div>
      <nav class="sidebar-nav">
        <ul>
          <li><a href="{% url 'dashboard' %}"><i class="fas fa-home"></i><span>Dashboard</span></a></li>
          <li><a href="{% url 'task' %}"><i class="fas fa-tasks"></i><span>Tasks</span></a></li>
          <li><a href="{% url 'schedule' %}" class="active"><i class="fas fa-calendar-alt"></i><span>Schedule</span></a></li>
          <li><a href="{% url 'analytics' %}"><i class="fas fa-chart-bar"></i><span>Analytics</span></a></li>
          <li><a href="{% url 'settings' %}"><i class="fas fa-cog"></i><span>Settings</span></a></li>
        </ul>
      </nav>
    </aside>

    <!-- Main -->
    <main class="main-content">
      <div class="schedule-container">
        <div class="schedule-header">
          <h2><i class="fas fa-calendar-alt"></i> My Schedule</h2>
        </div>
        <div class="calendar-container">
          <div id="calendar"></div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="taskModalBackdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Task</div>
        <button class="close-x" id="modalClose">&times;</button>
      </div>
      <div class="modal-body">
        <div class="modal-row"><strong>When:</strong> <span id="modalWhen"></span></div>
        <div class="modal-row"><strong>Category:</strong> <span id="modalCategory"></span></div>
        <div class="modal-row"><strong>Priority:</strong> <span id="modalPriority"></span></div>
        <div class="modal-row"><strong>Description:</strong><div id="modalDesc" style="white-space:pre-wrap;margin-top:4px;"></div></div>
      </div>
      <div class="modal-actions">
        <a id="openTasksPage" class="btn" href="{% url 'task' %}">Open Tasks</a>
        <button id="completeBtn" class="btn primary">Mark Completed</button>
        <button id="deleteBtn" class="btn danger">Delete</button>
      </div>
    </div>
  </div>

  <!-- FullCalendar JS -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <script>
    // Small helpers
    const $$ = (s, r=document) => r.querySelector(s);
    function fmt(dt){ try{ return new Date(dt).toLocaleString(); }catch{ return dt; } }
    function badgeFor(priority){
      const p = (priority||'medium').toLowerCase();
      const span = document.createElement('span');
      span.className = 'badge badge-' + p;
      span.textContent = p.charAt(0).toUpperCase() + p.slice(1);
      return span;
    }
    function getCookie(name) {
      const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
      return m ? m.pop() : '';
    }

    window.addEventListener('DOMContentLoaded', function () {
      const calendarEl = document.getElementById('calendar');
      const modal = $$('#taskModalBackdrop');
      const modalTitle = $$('#modalTitle');
      const modalWhen = $$('#modalWhen');
      const modalCategory = $$('#modalCategory');
      const modalPriority = $$('#modalPriority');
      const modalDesc = $$('#modalDesc');
      const modalClose = $$('#modalClose');
      const completeBtn = $$('#completeBtn');
      const deleteBtn = $$('#deleteBtn');

      // Init calendar
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: 'auto',
        headerToolbar: { left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek,timeGridDay' },
        events: { url: "{% url 'task_events' %}", method: "GET" },

        // Color by priority -> classNames fc-event-high/medium/low
        eventClassNames: arg => {
          const p = (arg.event.extendedProps?.priority || 'medium').toLowerCase();
          return [`fc-event-${p}`];
        },

        // Click to view modal (+ actions)
        eventClick: async function(info){
          info.jsEvent.preventDefault();
          const id = info.event.id;

          // Load latest task data
          const resp = await fetch(`/get-task/${id}/`, { credentials: 'same-origin' });
          const data = await resp.json();
          if (!data.success) return;

          const t = data.task;
          modalTitle.textContent = t.title || '(Untitled task)';
          modalWhen.textContent = `${fmt(t.start_time)}  â€”  ${fmt(t.end_time)}`;
          modalCategory.textContent = t.category || 'none';
          modalDesc.textContent = t.description || '(no description)';

          // Priority badge
          modalPriority.innerHTML = '';
          modalPriority.appendChild(badgeFor(t.priority));

          // Show modal
          modal.style.display = 'flex';

          // Complete -> POST to your endpoint then remove from calendar
          completeBtn.onclick = async () => {
            await fetch(`/complete-task/${id}/`, {
              method: 'POST',
              headers: { 'X-CSRFToken': getCookie('csrftoken') },
              credentials: 'same-origin'
            });
            // Remove event from calendar immediately
            const ev = calendar.getEventById(id);
            if (ev) ev.remove();
            modal.style.display = 'none';
          };

          // Delete -> DELETE endpoint then remove
          deleteBtn.onclick = async () => {
            await fetch(`/delete-task/${id}/`, {
              method: 'DELETE',
              headers: { 'X-CSRFToken': getCookie('csrftoken') },
              credentials: 'same-origin'
            });
            const ev = calendar.getEventById(id);
            if (ev) ev.remove();
            modal.style.display = 'none';
          };
        }
      });

      calendar.render();

      // Close modal
      modalClose.addEventListener('click', () => modal.style.display='none');
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.style.display = 'none';
      });
    });
  </script>
</body>
</html>
